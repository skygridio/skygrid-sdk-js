!function e(t,n,r){function i(s,u){if(!n[s]){if(!t[s]){var a="function"==typeof require&&require;if(!u&&a)return a(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var f=n[s]={exports:{}};t[s][0].call(f.exports,function(e){var n=t[s][1][e];return i(n?n:e)},f,f.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e){switch(e){case"create":case"read":case"update":case"delete":case"deviceKey":return}throw new Error("Access type '"+e+"' invalid, must be one of the following: create, read, update, delete")}Object.defineProperty(n,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=e("./Util"),a=r(u),c="*",f=function(){function e(t){i(this,e),t?t instanceof e?this._permissionsById=a.deepClone(t._permissionsById):this._permissionsById=a.deepClone(t):this._permissionsById={}}return s(e,[{key:"setAccess",value:function(e,t,n){var r=this;"string"==typeof t?this._setAccess(e,t,n):t instanceof Array&&t.map(function(t){r._setAccess(e,t,n)})}},{key:"setPublicAccess",value:function(e,t){this.setAccess(c,e,t)}},{key:"getAccess",value:function(e,t){return this._getAccess(e,t)}},{key:"getPublicAccess",value:function(e){return this._getAccess(c,e)}},{key:"removeAccess",value:function(e,t){var n=this;"string"==typeof t?this._removeAccess(e,t):t instanceof Array&&t.map(function(t){n._removeAccess(e,t)})}},{key:"removePublicAccess",value:function(e){this.removeAccess(c,e)}},{key:"toJSON",value:function(){return a.deepClone(this._permissionsById)}},{key:"_setAccess",value:function(e,t,n){if(o(t),e.id&&(e=e.id),"string"!=typeof e)throw new TypeError("userId must be a string.");if(null===n)n=void 0;else if("boolean"!=typeof n)throw new TypeError("allowed must be either true or false.");var r=this._permissionsById[e];if(!r){if(void 0===n)return;r={},this._permissionsById[e]=r}void 0!==n?r[t]=n:(delete r[t],a.objectEmpty(r)&&delete this._permissionsById[e])}},{key:"_getAccess",value:function(e,t){o(t),e.id&&(e=e.id);var n=this._permissionsById[e];return n?n[t]:null}},{key:"_removeAccess",value:function(e,t){var n=this._permissionsById[e];n&&(t&&(o(t),delete n[t]),t&&!a.objectEmpty(n)||delete this._permissionsById[e])}},{key:"permissions",get:function(){return this._permissionsById}},{key:"isEmpty",get:function(){return a.objectEmpty(this._permissionsById)}}]),e}();n.default=f},{"./Util":15}],2:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u=e("./EventEmitter"),a=r(u),c=function(e){function t(){return i(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),t}(a.default);n.default=c},{"./EventEmitter":5}],3:[function(e,t,n){(function(t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var r=e("./SkyGrid"),i=n(r),o=e("./SkyGridError"),s=n(o),u=e("./Acl"),a=n(u),c=e("./WebSocketApi"),f=n(c);t.SkyGrid=i.default,t.Acl=a.default,t.SkyGridError=s.default,t.WebSocketApi=f.default}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./Acl":1,"./SkyGrid":9,"./SkyGridError":10,"./WebSocketApi":16}],4:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=e("./SkyGridObject"),l=i(f),h=e("./SkyGridError"),d=i(h),p=e("./Acl"),y=i(p),_=e("./Schema"),b=i(_),v=e("./Util"),m=r(v),g=function(e){function t(e,n){if(o(this,t),!n)throw new Error("No device data/ID supplied");var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._api=e.api,r._subManager=e.subscriptionManager,r._subCallbacks={},r._subCount=0,r._serverSubId=null,r._changeDefaults={properties:{}},r._fetched=!1,r.discardChanges(),"object"===("undefined"==typeof n?"undefined":a(n))?(m.fixDataDates(n),r._data=n,r._fetched=!!n.properties):"string"==typeof n&&(r._data={id:n,properties:{}}),r}return u(t,e),c(t,[{key:"set",value:function(e,t){this._changes.properties[e]=t,this._changed=!0}},{key:"get",value:function(e){return this._changes.properties.hasOwnProperty(e)?this._changes.properties[e]:this.propertyExists(e)?this._data.properties[e]:null}},{key:"propertyExists",value:function(e){return this._data.properties.hasOwnProperty(e)}},{key:"save",value:function(e){if(e)for(var t in e)this._changes.properties[t]=e[t],this._changed=!0;return this._saveChanges({default:{deviceId:this.id},requestName:"device.update",fields:["name","log","properties"],hasAcl:!0})}},{key:"fetch",value:function(){var e=this;return this._fetch("device.get",{deviceId:this.id}).then(function(){return m.fixDataDates(e._data),e})}},{key:"history",value:function(e,t,n){var r={deviceId:this.id},i={};return e&&("string"==typeof e&&(e=new Date(e)),e instanceof Date?i.time={$gte:e}:"object"==("undefined"==typeof e?"undefined":a(e))&&(i=e)),t&&("string"==typeof t&&(t=new Date(t)),t instanceof Date&&(i.time||(i.time={}),i.time.$lt=t)),r.constraints=i,n&&("number"!=typeof n&&(n=parseInt(n)),r.limit=n),this._api.request("device.history",r).then(function(e){return e.map(function(e){e.time=new Date(e.time)}),e})}},{key:"remove",value:function(){return this._api.request("device.delete",{deviceId:this.id})}},{key:"subscribe",value:function(e){var t=this;return Promise.resolve().then(function(){if(null===t._serverSubId)return t._subManager.addSubscription({deviceId:t.id},function(e,n){t._data=n._data,t._fetched=!0;for(var r in t._subCallbacks){var i=t._subCallbacks[r];i(e,t)}}).then(function(e){t._serverSubId=e})}).then(function(){var n=t._subCount++;return t._subCallbacks[n]=e,n})}},{key:"unsubscribe",value:function(e){var t=this;if(e){if("function"==typeof e&&(e=this._findSubId(e),null===e))throw new d.default("Subscription does not exist");if(void 0===this._subCallbacks[e])throw new d.default("Subscription does not exist");delete this._subCallbacks[e]}else this._subCallbacks={};return m.objectEmpty(this._subCallbacks)?this._subManager.removeSubscription(this._serverSubId).then(function(){t._serverSubId=null}):Promise.resolve()}},{key:"_findSubId",value:function(e){for(var t in this._subCallbacks)if(this._subCallbacks[t]===e)return t;return null}},{key:"name",get:function(){return this._getDataProperty("name")},set:function(e){this._setDataProperty("name",e)}},{key:"acl",get:function(){return this._changes.acl||(this._data.acl?this._changes.acl=new y.default(this._data.acl):this._changes.acl=new y.default,this._changed=!0),this._changes.acl},set:function(e){e&&"object"===("undefined"==typeof e?"undefined":a(e))&&(e instanceof y.default||(e=new y.default(e))),this._setDataProperty("acl",e)}},{key:"log",get:function(){return this._getDataProperty("log")},set:function(e){this._setDataProperty("log",e)}},{key:"schemaId",get:function(){return this._data.schemaId}},{key:"schema",get:function(){return new b.default(this._api,this.schemaId)}},{key:"properties",get:function(){var e=new Map;for(var t in this._data.properties)e.set(t,this._data.properties[t]);for(var n in this._changes.properties)e.set(n,this._changes.properties[n]);return e}}]),t}(l.default);n.default=g},{"./Acl":1,"./Schema":8,"./SkyGridError":10,"./SkyGridObject":11,"./Util":15}],5:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function e(){r(this,e)};n.default=i},{}],6:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e){return e=e||{},e.api||(e.api="websocket"),e.address||(e.address=q),"websocket"!==e.api||E.hasWebSocketsupport()||(e.api="rest"),e}Object.defineProperty(n,"__esModule",{value:!0});var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=e("./SubscriptionManager"),h=i(l),d=e("./SkyGridError"),p=i(d),y=e("./SkyGridObject"),_=i(y),b=e("./WebSocketApi"),v=i(b),m=e("./RestApi"),g=i(m),k=e("./Device"),w=i(k),S=e("./Schema"),P=i(S),j=e("./User"),O=i(j),I=e("./Util"),E=r(I),q="https://api.skygrid.io",C=function(e){function t(e,n){o(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));switch(n=a(n),n.api){case"rest":r._api=new g.default(n.address,e);break;case"websocket":r._api=new v.default(n.address,e);break;default:throw new p.default("Unsupported api type "+n.api)}return r._projectId=e,r._serverTime=0,r._subManager=new h.default(r._api),r._subCallbacks={},r._subCount=0,r._serverSubId=null,r._user=null,r._data={id:e},r._setupListeners(),r._timeInterval=setInterval(function(){r.fetchServerTime()},3e4),r.fetchServerTime(),r}return u(t,e),f(t,[{key:"fetchServerTime",value:function(){var e=this;return this._api.request("getServerTime").then(function(t){return e._serverTime=new Date(t),e._timeOffset=e._serverTime-new Date,t})}},{key:"loginMaster",value:function(e){return this._api.request("session.loginMaster",{masterKey:e})}},{key:"login",value:function(e,t){var n=this;return this._api.request("session.loginUser",{email:e,password:t}).then(function(t){n._user={email:e,id:t.userId,token:t.token}})}},{key:"logout",value:function(){var e=this;return this._api.request("session.logout").then(function(){e._user=null})}},{key:"signup",value:function(e,t,n){return this._api.request("user.add",{email:e,password:t,meta:n}).then(function(e){return e.id})}},{key:"user",value:function(e){return new O.default(this._api,e)}},{key:"users",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._api.request("user.find",{constraints:e,fetch:n}).then(function(e){return e.map(function(e){return t.user(e)})})}},{key:"addSchema",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._api.request("schema.add",{name:e,properties:n}).then(function(e){return t.schema(e.id).fetch()})}},{key:"schema",value:function(e){return new P.default(this._api,e)}},{key:"schemas",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._api.request("schema.find",{constraints:e,fetch:n}).then(function(e){return e.map(function(e){return t.schema(e)})})}},{key:"addDevice",value:function(e,t){var n=this;if("object"===("undefined"==typeof t?"undefined":c(t))&&"string"==typeof t.id&&(t=t.id),"string"==typeof t)return this._api.request("device.add",{name:e,schemaId:t}).then(function(e){return n.device(e.id).fetch()});throw new p.default("Invalid schema")}},{key:"device",value:function(e){return new w.default({api:this._api,subscriptionManager:this._subManager},e)}},{key:"devices",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._api.request("device.find",{constraints:e,fetch:n}).then(function(e){return e.map(function(e){return t.device(e)})})}},{key:"fetch",value:function(){return this._fetch("project.get",{projectId:this.id})}},{key:"save",value:function(){if(!this._api._masterKey)throw new p.default("Can only edit projects when using the master key");return this._saveChanges({default:{projectId:this.id},requestName:"project.update",fields:["allowSignup","meta"],hasAcl:!0})}},{key:"subscribe",value:function(e,t){var n=this;return t||(t=e),Promise.resolve().then(function(){if(null===n._serverSubId)return n._subManager.addSubscription({projectId:n.id},function(e,t){for(var r in n._subCallbacks){var i=n._subCallbacks[r];i(e,t)}}).then(function(e){n._serverSubId=e})}).then(function(){var e=n._subCount++;return n._subCallbacks[e]=t,e})}},{key:"unsubscribe",value:function(e){var t=this;if(e){if("function"==typeof e&&(e=this._findSubId(e),null===e))throw new p.default("Subscription does not exist");if(void 0===this._subCallbacks[e])throw new p.default("Subscription does not exist");delete this._subCallbacks[e]}else this._subCallbacks={};return E.objectEmpty(this._subCallbacks)?this._subManager.removeSubscription(this._subId).then(function(){t._subId=null}):Promise.resolve()}},{key:"unsubscribeAll",value:function(){return this._subManager.removeSubscriptions()}},{key:"requestPasswordReset",value:function(e){return this._api.request("user.requestPasswordReset",{email:e})}},{key:"resetPassword",value:function(e,t,n){return this._api.request("user.resetPassword",{email:e,resetToken:t,password:n})}},{key:"close",value:function(){var e=this;return this.unsubscribeAll().then(function(){return e._api.close()}).then(function(){clearInterval(e._timeInterval),e._projectId=null,e._user=null,e._timeInterval=null,e._data=null,e._changes=null})}},{key:"_setupListeners",value:function(){var e=this;this._api.on("connect",function(){e._subManager.requestSubscriptions()}),this._api.on("update",function(t){var n=e.device(t.device);e._subManager.raise(t.id,t.changes,n)}),this._api.on("disconnect",function(){e._subManager.invalidateSubscriptions()})}},{key:"name",get:function(){return this._getDataProperty("name")}},{key:"allowSignup",get:function(){return this._getDataProperty("allowSignup")},set:function(e){this._setDataProperty("allowSignup",e)}},{key:"acl",get:function(){return this._getAclProperty()},set:function(e){this._setAclProperty(e)}},{key:"meta",get:function(){return this._getDataProperty("meta")},set:function(e){this._setDataProperty("meta",e)}},{key:"serverTime",get:function(){return this._serverTime}}]),t}(_.default);n.default=C},{"./Device":4,"./RestApi":7,"./Schema":8,"./SkyGridError":10,"./SkyGridObject":11,"./SubscriptionManager":13,"./User":14,"./Util":15,"./WebSocketApi":16}],7:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){if(e.status>=200&&e.status<300)return e;var t=new Error(e.statusText);throw t.response=e,t}function a(e){return 204!==e.status?e.json():{}}function c(e,t){return t&&(e+="?where="+encodeURIComponent(JSON.stringify(t))),e}Object.defineProperty(n,"__esModule",{value:!0});var f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=e("./Api"),h=r(l),d=e("./SkyGridError"),p=r(d),y=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._address=e,r._projectId=n,r._masterKey=null,r._token=null,r._endPoints={signup:function(e){return r._fetchJson("/users",{method:"post",body:e})},login:function(e){return r._fetchJson("/login",{method:"post",body:e}).then(function(e){return r._token=e.token,e})},loginMaster:function(e){return r._masterKey=e.masterKey,Promise.resolve()},logout:function(){return r._fetchJson("/logout",{method:"post"})},fetchUser:function(e){return r._fetchJson("/users/"+e.userId,{method:"get"})},findUsers:function(e){var t=c("/users",e.constraints);return r._fetchJson(t,{method:"get"})},deleteUser:function(e){return r._fetchJson("/users/"+e.userId,{method:"delete"})},requestPasswordReset:function(e){return r._fetchJson("/users/requestPasswordReset",{method:"post",body:e})},resetPassword:function(e){return r._fetchJson("/users/resetPassword",{method:"post",body:e})},fetchProject:function(e){return r._fetchJson("/projects/"+e.projectId,{method:"get"})},updateProject:function(e){return r._fetchJson("/projects/"+e.projectId,{method:"put",body:e})},addDeviceSchema:function(e){return r._fetchJson("/schemas",{method:"post",body:e})},findDeviceSchemas:function(e){var t=c("/schemas",e.constraints);return r._fetchJson(t,{method:"get"})},fetchDeviceSchema:function(e){return r._fetchJson("/schemas/"+e.schemaId,{method:"get"})},updateDeviceSchema:function(e){var t=e.schemaId;return delete e.schemaId,r._fetchJson("/schemas/"+t,{method:"put",body:e})},deleteDeviceSchema:function(e){return r._fetchJson("/schemas/"+e.schemaId,{method:"delete"})},findDevices:function(e){var t=c("/devices",e.constraints);return r._fetchJson(t,{method:"get"})},addDevice:function(e){return r._fetchJson("/devices",{method:"post",body:e})},fetchDevice:function(e){return r._fetchJson("/devices/"+e.deviceId,{method:"get"})},updateDevice:function(e){var t=e.deviceId;return delete e.deviceId,r._fetchJson("/devices/"+t,{method:"put",body:e})},deleteDevice:function(e){return r._fetchJson("/devices/"+e.deviceId,{method:"delete"})},fetchHistory:function(e){return r._fetchJson("/history/"+e.deviceId,{method:"get"})},getServerTime:function(){return r._fetchJson("/time",{method:"get"})}},r}return s(t,e),f(t,[{key:"close",value:function(){}},{key:"request",value:function(e,t){var n=this._endPoints[e];if(n)return n(t);throw new p.default("API end point '"+e+"' does not exist on the REST API")}},{key:"_fetchJson",value:function(e,t){t.headers||(t.headers={}),t.headers.Accept="application/json",t.headers["Content-Type"]="application/json",this._token?t.headers["X-Access-Token"]=this._token:(this._masterKey&&(t.headers["X-Master-Key"]=this._masterKey),t.headers["X-Project-ID"]=this._projectId),t.body&&(t.body=JSON.stringify(t.body));var n=this._address+e;return fetch(n,t).then(u).then(a)}}]),t}(h.default);n.default=y},{"./Api":2,"./SkyGridError":10}],8:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=e("./SkyGridObject"),f=r(c),l=e("./SkyGridError"),h=r(l),d=function(e){function t(e,n){if(i(this,t),!n)throw new Error("No schema data/ID supplied");var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(r._api=e,r._changeDefaults={properties:{}},r.discardChanges(),"object"===("undefined"==typeof n?"undefined":u(n)))r._data=n,r._fetched=!!n.properties;else{if("string"!=typeof n)throw new Error("Schema data is of an unknown type");r._data={id:n,properties:{}}}return r}return s(t,e),a(t,[{key:"addProperty",value:function(e,t,n){this._changes.properties[e]={type:t,default:n},this._changed=!0}},{key:"updateProperty",value:function(e,t,n){var r=this._changes[e];if(!r)throw new Error("Property '"+e+"' does not exist");t&&(r.type=t),n&&(r.default=n),this._changed=!0}},{key:"getProperty",value:function(e){return this._changes.properties.hasOwnProperty(e)?this._changes.properties[e]:this._data.properties.hasOwnProperty(e)?this._data.properties[e]:null}},{key:"removeProperty",value:function(e){this._changes.properties[e]=null,this._changed=!0}},{key:"save",value:function(){if(!this._api._masterKey)throw new h.default("Can only edit schemas when using the master key");return this._saveChanges({default:{schemaId:this.id},requestName:"updateDeviceSchema",fields:["name","description","properties"],hasAcl:!0})}},{key:"fetch",value:function(){return this._fetch("fetchDeviceSchema",{schemaId:this.id})}},{key:"remove",value:function(){return this._api.request("deleteDeviceSchema",{schemaId:this.id})}},{key:"name",get:function(){return this._getDataProperty("name")},set:function(e){this._setDataProperty("name")}},{key:"acl",get:function(){return this._getAclProperty()},set:function(e){this._setAclProperty(e)}},{key:"properties",get:function(){var e=new Map;for(var t in this._data.properties)e.set(t,this._data.properties[t]);for(var n in this._changes.properties)e.set(n,this._changes.properties[n]);return e}}]),t}(f.default);n.default=d},{"./SkyGridError":10,"./SkyGridObject":11}],9:[function(e,t,n){"use strict";var r=e("./Project");n.project=function(e,t){return new r.default(e,t)}},{"./Project":6}],10:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function e(t){r(this,e),this.message=t,"captureStackTrace"in Error?Error.captureStackTrace(this,e):this.stack=(new Error).stack};n.default=i},{}],11:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("./Acl"),c=i(a),f=e("./Util"),l=r(f),h=function(){function e(){o(this,e),this._data={},this._fetched=!1,this._changes={},this._changed=!1,this._changeDefaults={},this._api=null}return u(e,[{key:"discardChanges",value:function(){this._changes=l.deepClone(this._changeDefaults),this._changed=!1}},{key:"save",value:function(){throw new Error("save not implemented for this object")}},{key:"fetch",value:function(){throw new Error("fetch not implemented for this object")}},{key:"fetchIfNeeded",value:function(){return this._fetched!==!0?this.fetch():Promise.resolve(this)}},{key:"_setDataProperty",value:function(e,t){this._changes[e]=t,this._changed=!0}},{key:"_getDataProperty",value:function(e){return this._changes.hasOwnProperty(e)?this._changes[e]:this._data[e]}},{key:"_getAclProperty",value:function(){return this._changes.acl||(this._data.acl?this._changes.acl=new c.default(this._data.acl):this._changes.acl=new c.default,this._changed=!0),this._changes.acl}},{key:"_setAclProperty",value:function(e){e&&"object"===("undefined"==typeof e?"undefined":s(e))&&(e instanceof c.default||(e=new c.default(e))),this._setDataProperty("acl",e)}},{key:"_saveChanges",value:function(e){var t=this;if(this._changed===!0){var n=l.prepareChanges(this._changes,e.default);return this._api.request(e.requestName,n).then(function(){return l.mergeFields(t._data,t._changes,e.fields),e.hasAcl&&l.mergeAcl(t._data,t._changes),t.discardChanges(),t})}return Promise.resolve(this)}},{key:"_fetch",value:function(e,t){var n=this;return this._api.request(e,t).then(function(e){n._data=e,n._fetched=!0}).then(function(){return n})}},{key:"id",get:function(){return this._data.id}},{key:"isDirty",get:function(){return this._changed===!0}},{key:"isComplete",get:function(){return this._fetched===!0}}]),e}();n.default=h},{"./Acl":1,"./Util":15}],12:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("./EventEmitter"),c=r(a),f=function(e){function t(e){i(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._socket=new WebSocket(e),n._reconnect=!0,n._requestId=0,n._requests={},n._requestQueue=[],n._socket.onopen=function(){for(var e=n._requestQueue.length,t=0;t<e;t++)n._requestQueue[t]();n._requestQueue=n._requestQueue.splice(e,n._requestQueue.length-e),n.emit("connect")},n._socket.onclose=function(){n.emit("disconnect")},n._socket.onmessage=function(e){var t=JSON.parse(e.data);if(n._requests.hasOwnProperty(t.requestId)){var r=n._requests[t.requestId];r(t),delete n._requests[t.requestId]}else n.emit("update",t)},n._socket.onerror=function(e){throw new Error(e)},n}return s(t,e),u(t,[{key:"send",value:function(e){switch(this._socket.readyState){case WebSocket.CONNECTING:return this._queueMessage(e);case WebSocket.CLOSING:case WebSocket.CLOSED:throw new Error("Websocket is closed")}return this._handleSend(e)}},{key:"close",value:function(){this._requestQueue=[],this._reconnect=!1,this._socket.close()}},{key:"_queueMessage",value:function(e){var t=this;return new Promise(function(n,r){t._requestQueue.push(function(){t._handleSend(e).then(n).catch(r)})})}},{key:"_handleSend",value:function(e){var t=this;return e.requestId=this._requestId++,this._socket.send(JSON.stringify(e)),new Promise(function(n,r){t._requests[e.requestId]=function(e){n(e)}})}},{key:"state",get:function(){return this._socket.readyState}}]),t}(c.default);n.default=f},{"./EventEmitter":5}],13:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("./SkyGridError"),u=r(s),a=function(){function e(t){i(this,e),this._api=t,this._subscriptions={},this._subscriptionCount=0}return o(e,[{key:"addSubscription",value:function(e,t){"function"==typeof e&&(t=e,e={}),e.subscriptionId=this._subscriptionCount++;var n={settings:e,callback:t,active:!1};return this._requestSubscription(n)}},{key:"removeSubscription",value:function(e){return this._api?this._api.request("unsubscribe",{subscriptionId:e}):Promise.reject()}},{key:"raise",value:function(e,t,n){var r=this._subscriptions[e];if(!r)throw new u.default("Subscription not found");r.callback(t,n)}},{key:"requestSubscriptions",value:function(){for(var e in this._subscriptions){var t=this._subscriptions[e];t.active===!1&&this._requestSubscription(t)}}},{key:"invalidateSubscriptions",value:function(){for(var e in this._subscriptions)this._subscriptions[e].active=!1}},{key:"removeSubscriptions",value:function(){var e=this;if(this._api){var t=[];for(var n in this._subscriptions)t.push(this.removeSubscription(n));return Promise.all(t).then(function(){e._subscriptions={}})}return Promise.reject()}},{key:"_requestSubscription",value:function(e){var t=this;return this._api.request("subscribe",e.settings).then(function(){e.active=!0,t._subscriptions[e.settings.subscriptionId]=e}).then(function(){return e.settings.subscriptionId})}}]),e}();n.default=a},{"./SkyGridError":10}],14:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t;
}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=e("./SkyGridObject"),f=r(c),l=e("./SkyGridError"),h=r(l),d=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._api=e,"object"===("undefined"==typeof n?"undefined":u(n))?(r._data=n,r._fetched=!!n.meta):"string"==typeof n&&(r._data={id:n}),r}return s(t,e),a(t,[{key:"save",value:function(){if(!this._api._masterKey)throw new h.default("Can only edit users when using the master key");return this._saveChanges({default:{userId:this.id},requestName:"updateUser",fields:["email","meta"]})}},{key:"fetch",value:function(){return this._fetch("fetchUser",{userId:this.id})}},{key:"remove",value:function(){return this._api.request("deleteUser",{userId:this.id})}},{key:"email",get:function(){return this._getDataProperty("email")},set:function(e){this._setDataProperty("email",e)}},{key:"meta",get:function(){return this._getDataProperty("meta")},set:function(e){this._setDataProperty("meta",e)}},{key:"password",set:function(e){this._setDataProperty("password",e)}}]),t}(f.default);n.default=d},{"./SkyGridError":10,"./SkyGridObject":11}],15:[function(e,t,n){"use strict";function r(e){for(var t in e)return!1;return!0}function i(e){return JSON.parse(JSON.stringify(e))}function o(e,t,n){n.map(function(n){var r=t[n];if(void 0!==r)if("object"!==("undefined"==typeof r?"undefined":f(r)))e[n]=r;else{var i=e[n];for(var o in r)i[o]=r[o]}})}function s(e,t){void 0!==t.acl&&(null===t.acl||t.acl.isEmpty()?delete e.acl:e.acl=t.acl)}function u(e,t){for(var n in e)"acl"!==n?t[n]=e[n]:null!==e.acl?t.acl=e.acl.toJSON():t.acl=null;return t}function a(e){e.createdAt&&(e.createdAt=new Date(e.createdAt)),e.updatedAt&&(e.updatedAt=new Date(e.updatedAt))}function c(){return"WebSocket"in window&&2===window.WebSocket.CLOSING}Object.defineProperty(n,"__esModule",{value:!0});var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.objectEmpty=r,n.deepClone=i,n.mergeFields=o,n.mergeAcl=s,n.prepareChanges=u,n.fixDataDates=a,n.hasWebSocketSupport=c},{}],16:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("./SkyGridWebSocket"),c=r(a),f=e("./Api"),l=r(f),h="session.loginMaster",d=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r._address=e,r._projectId=n,r._session=!1,r._connected=!1,r._socket=null,r._masterKey=null,r._socket=new c.default(e),r}return s(t,e),u(t,[{key:"close",value:function(){this._socket.close(),this._socket=null,this._session=!1,this._connected=!1,this._masterKey=null}},{key:"request",value:function(e,t){var n=this;return e===h&&(this._masterKey=t.masterKey),this._session?this._makeRequest(e,t):this._makeRequest("session.create",{projectId:this._projectId}).then(function(){if(n._session=!0,e!==h&&n._masterKey)return n._makeRequest(h,{masterKey:n._masterKey})}).then(function(){return n._makeRequest(e,t)})}},{key:"_makeRequest",value:function(e,t){var n={endpoint:e};return t&&(n.body=t),this._socket.send(n).then(function(e){if(e.code>=200&&e.code<300)return e.body||{};if("string"==typeof e.body)throw new SkyGridError(e.body)})}}]),t}(l.default);n.default=d},{"./Api":2,"./SkyGridWebSocket":12}]},{},[3]);